<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Ecsepheto | 日语 IPA 转换器 (独立版)</title>
    <style>
        /* 页面样式：保持之前的简洁学术风 */
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding-top: 50px; color: #333; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 600px; text-align: center; }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; display: inline-block; margin-bottom: 30px; }
        input { width: 80%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1.2rem; outline: none; transition: border 0.3s; }
        input:focus { border-color: #3498db; }
        .result-box { margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 50px; }
        .label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        #output { font-size: 2rem; color: #2980b9; font-weight: bold; font-family: "Lucida Sans Unicode", sans-serif; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ecsepheto IPA Converter</h1>
    <input type="text" id="kanaInput" placeholder="输入平假名或片假名..." oninput="convert()">
    
    <div class="result-box">
        <div class="label">International Phonetic Alphabet</div>
        <div id="output"></div>
    </div>
</div>

<script>
    // --- 第一部分：直接嵌入数据 (替代 require('./ipa.json')) ---
    const IPA_MAP = {
      "ア":"a", "イ":"i", "ウ":"ɯ", "エ":"e", "オ":"o",
      "ャ":"ja", "ュ":"jɯ", "ョ":"jo",
      "カ":"ka", "キ":"kʲi", "ク":"kɯ", "ケ":"ke", "コ":"ko",
      "サ":"sa", "シ":"ɕi", "ス":"sɯ", "セ":"se", "ソ":"so",
      "タ":"ta", "チ":"t͡ɕi", "ツ":"tsɯ", "テ":"te", "ト":"to",
      "ナ":"na", "ニ":"ɲi", "ヌ":"nɯ", "ネ":"ne", "ノ":"no",
      "ハ":"ha", "ヒ":"çi", "フ":"ɸɯ", "ヘ":"he", "ホ":"ho",
      "マ":"ma", "ミ":"mi", "ム":"mɯ", "メ":"me", "モ":"mo",
      "ヤ":"ja", "ユ":"jɯ", "ヨ":"jo",
      "ラ":"ɾa", "リ":"ɾi", "ル":"ɾɯ", "レ":"ɾe", "ロ":"ɾo",
      "ワ":"ɰa", "ヰ":"i", "ヱ":"e", "ヲ":"o", "ン":"N",
      "ガ":"ɡa", "ギ":"ɡʲi", "グ":"ɡɯ", "ゲ":"ɡe", "ゴ":"ɡo",
      "ザ":"za", "ジ":"dʑi", "ズ":"zɯ", "ゼ":"ze", "ゾ":"zo",
      "ダ":"da", "ヂ":"ʑi", "ヅ":"dzɯ", "デ":"de", "ド":"do",
      "バ":"ba", "ビ":"bi", "ブ":"bɯ", "ベ":"be", "ボ":"bo",
      "パ":"pa", "ピ":"pi", "プ":"pɯ", "ペ":"pe", "ポ":"po"
    };

    // --- 第二部分：直接嵌入数据 (替代 require('./ipa-small.json')) ---
    const IPA_SMALL_MAP = {
      "キャ":"kʲa", "キュ":"kʲɯ", "キョ":"kʲo",
      "シャ":"ɕa", "シュ":"ɕɯ", "ショ":"ɕo",
      "チャ":"t͡ɕa", "チュ":"t͡ɕɯ", "チョ":"t͡ɕo",
      "ニャ":"ɲa", "ニュ":"ɲɯ", "ニョ":"ɲo",
      "ヒャ":"ça", "ヒュ":"çɯ", "ヒョ":"ço",
      "ミャ":"mʲa", "ミュ":"mʲɯ", "ミョ":"mʲo",
      "リャ":"ɾʲa", "リュ":"ɾʲɯ", "リョ":"ɾʲo",
      "ギャ":"ɡʲa", "ギュ":"ɡʲɯ", "ギョ":"ɡʲo",
      "ジャ":"ʑa", "ジュ":"ʑɯ", "ジョ":"ʑo",
      "ヂャ":"ʑa", "ヂュ":"ʑɯ", "ヂョ":"ʑo",
      "ビャ":"bʲa", "ビュ":"bʲɯ", "ビョ":"bʲo",
      "ピャ":"pʲa", "ピュ":"pʲɯ", "ピョ":"pʲo",
      "ファ":"ɸa", "フィ":"ɸi", "フゥ":"ɸɯ", "フェ":"ɸe", "フォ":"ɸo",
      "チェ":"t͡ɕe"
    };

    // --- 第三部分：核心逻辑 (移植并修改自 converter.js) ---
    const KanaConverter = {
        // 将平假名转为片假名
        // 原码使用了 XRegExp 库，这里我们用原生 JS 的 Unicode 正则替代，无需外部依赖
        hiragana2katakana(text) {
            return text.replace(/\p{Script=Hiragana}/gu, (char) => {
                return String.fromCharCode(char.charCodeAt(0) + 0x60);
            });
        },

        kana2ipa(inText) {
            if (!inText || inText.length <= 0) {
                return "";
            }

            // 1. 准备拗音正则 (SMALL KANA)
            // 原码：Object.keys(ipa_small).join('|')
            let ipa_small_match = Object.keys(IPA_SMALL_MAP).join('|').replace(/.*/, '($&)');

            // 2. 统一转为片假名
            let katakanaText = this.hiragana2katakana(inText);

            // 3. 基础替换逻辑
            let bIpaString = katakanaText
                .normalize('NFKC') // 宽窄字符标准化
                .replace(new RegExp(ipa_small_match, 'g'), (v) => (IPA_SMALL_MAP[v] || v))
                .match(/./ug) // 按字符分割
                .map((v) => IPA_MAP[v] || v) // 查表替换
                .join('');

            // 4. 处理 "ん" (N) 的特殊发音规则
            let nIpaString = bIpaString
                // 1. 后面接 p/b/m -> 变 m
                .replace(/(.)N(p|b)/ug, '$1\u0303mː$2')
                // 2. 后面接 t/d/n... -> 变 n
                .replace(/(.)N(t|d|ts|n)/ug, '$1\u0303nː$2')
                // 3. 后面接 k/g -> 变 ŋ
                .replace(/(.)N(k|g|ɡ)/ug, '$1\u0303ŋː$2')
                // 4. 后面接 r -> 变 n (或处理为 flap)
                .replace(/(.)N(r)/ug, '$1\u0303nː$2')
                // 5. 后面接元音/半元音/近音/擦音 -> 特殊鼻化元音 
                .replace(/(.)N(a|i|ɯ|e|o|h|j|w)/ug, '$1\u0303$1\u0303$2')

                // Add-ons
                // 6. 后面接 ch, j, n -> 变 ɲ
                .replace(/(.)N(t͡ɕ|ʑ|ɲ)/ug, '$1\u0303ɲːː')
                // 7. 后面接 m -> 变 m：：，且前一个音鼻化
                .replace(/(.)N(m)/ug, '$1\u0303mːː')
                // 7. 后面接 s -> 变 ɰ͂:，且前一个音鼻化
                .replace(/(.)N(s)/ug, '$1\u0303ɰ͂:$2')

                // 8. m/n/ɲ 前的元音鼻化
                // 逻辑：找到 [元音] + [m或n或ɲ] + [元音]，给第一个元音戴上波浪号
                // (m(?:ʲ)? 意思是匹配 m 或 mʲ，用来兼容 mi/myu)
                .replace(/([aiɯeo])(m(?:ʲ)?|n|ɲ)(?=[aiɯeo])/ug, '$1\u0303$2')

                // 0. 兜底 -> 变 ɴ
                .replace(/(.)N( )/ug, '$1\u0303ɴ ')
                // 0. 词尾 -> 变 ɴ：
                .replace(/(.)N/ug, '$1\u0303ɴː')
                .normalize('NFC');

            // 5. 处理促音和长音
            let mIpaString = nIpaString
                // 促音：在 (.) 前面加了 (t͡?ɕ|t͡?s|...) 来优先捕捉塞擦音
                .replace(/ッ(t͡?ɕ|t͡?ʃ|t͡?s|d͡?z|d͡?ʒ|.)/ug, (match, p1) => {
                    // 逻辑：取出捕捉到的音的第一个字母，加在前面
                    // 比如 p1 是 "tɕ"，firstChar 就是 "t" -> 返回 "ttɕ"
                    let firstChar = p1.charAt(0);
                    return firstChar + p1.substring(1) + 'ːː';
                })
                .replace(/mm/ug, 'mː')
                .replace(/nn/ug, 'nː')
                .replace(/oɯ/ug, 'oː')       // 修正 "ou" 为长音 o:
                .replace(/(.)ー/ug, '$1ː')   // 长音符号
                .normalize('NFC');

            return mIpaString;
        }
    };

    // --- 第四部分：连接到网页 ---
    function convert() {
        const input = document.getElementById('kanaInput').value;
        const result = KanaConverter.kana2ipa(input);
        document.getElementById('output').innerText = result ? `[ ${result} ]` : "";
    }
</script>

</body>
</html>